{
	# Global Options
	auto_https enable_redirects
	log {
		format json
		level INFO
	}

	servers {
		trusted_proxies static 0.0.0.0/0
	}
}

{{ $hosts := groupByLabel $ "virtual.host" }}

{{ if not $hosts }}

127.0.0.1:2015 {
  log {
      output stdout
  }
}

{{ else }}

{{ range $h, $containers := $hosts }}
{{ $c := first $containers }}
{{ $allhosts := trim (index $c.Labels "virtual.host") }}
{{ range $t, $host := split $allhosts " " }}
{{ $tlsEmail := trim (index $c.Labels "virtual.tls-email") }}
{{ $tlsConfig := trim (index $c.Labels "virtual.tls") }}
{{ $tlsEnv := or $tlsEmail $tlsConfig }}
{{ $tlsOff := eq $tlsEnv "" }}
{{ $tlsOn := ne $tlsEnv "" }}
{{ $alias := trim (index $c.Labels "virtual.alias") }}
{{ $aliasPresent := ne $alias "" }}
{{ $authUsername := trim (index $c.Labels "virtual.auth.username") }}
{{ $authPassword := trim (index $c.Labels "virtual.auth.password") }}
{{ $authPath := trim (index $c.Labels "virtual.auth.path") }}
{{ $basicauth := and (ne $authUsername "") (ne $authPassword "") }}
{{ $hostDirectives := trim (index $c.Labels "virtual.host.directives") }}
{{ $hostImport := trim (index $c.Labels "virtual.host.import") }}
{{ $proxyMatcher := trim (index $c.Labels "virtual.proxy.matcher") }}
{{ $proxyDirectives := trim (index $c.Labels "virtual.proxy.directives") }}
{{ $proxyLBPolicy := or (trim (index $c.Labels "virtual.proxy.lb_policy")) "round_robin" }}
{{ $proxyImport := trim (index $c.Labels "virtual.proxy.import") }}

# JWT Configuration from virtual labels
{{ $jwtIssuer := trim (index $c.Labels "virtual.jwt.issuer") }}
{{ $jwtAudience := trim (index $c.Labels "virtual.jwt.audience") }}
{{ $jwtJwks := trim (index $c.Labels "virtual.jwt.jwks_uri") }}
{{ $jwtRole := trim (index $c.Labels "virtual.jwt.require_role") }}
{{ $jwtEnabled := and (ne $jwtIssuer "") (ne $jwtJwks "") }}

{{ if $aliasPresent  }}
{{ if $tlsOff }}http://{{ end }}{{ $alias }} {
  redir {{ if $tlsOff }}http://{{ else }}https://{{ end }}{{ $host }}
}
{{ end }}

{{ if $tlsOff }}http://{{ end }}{{ $host }} {
  {{ if $tlsOn }}tls {{ $tlsEnv }}{{ end }}
  
  encode zstd gzip
  
  {{ if $tlsOn }}
  # โหมด HTTPS → ลบ fingerprint + ใส่ HSTS
  header {
    -Server
    -X-Powered-By
    Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    X-Content-Type-Options "nosniff"
    X-Frame-Options "DENY"
    Referrer-Policy "strict-origin-when-cross-origin"
  }
  {{ else }}
  # โหมด HTTP ธรรมดา → ลบ fingerprint อย่างเดียว
  header {
    -Server
    -X-Powered-By
    X-Content-Type-Options "nosniff"
    X-Frame-Options "DENY"
    Referrer-Policy "strict-origin-when-cross-origin"
  }
  {{ end }}

  {{ $hostDirectives }}
  {{ if $hostImport }}import {{ $hostImport }}{{ end }}

  {{ if $jwtEnabled }}
  # ===== JWT AUTH BLOCK =====
  route {
    jwt {
      primary yes
      trusted_tokens {
        static_secret {
          token_name access_token
        }
      }

      issuers {
        oidc {
          issuer {{ $jwtIssuer }}
          metadata_url {{ $jwtIssuer }}/.well-known/openid-configuration
          audience {{ $jwtAudience }}
        }
      }

      validate {
        exp
        nbf
        iat
      }
    }

    # ===== ROLE CHECK =====
    {{ if $jwtRole }}
    @forbidden not claim roles contains {{ $jwtRole }}
    respond @forbidden 403
    {{ end }}

    # ===== FORWARD CLAIMS + REVERSE PROXY =====
    reverse_proxy {{ $proxyMatcher }} {
      lb_policy {{ $proxyLBPolicy }}
      {{ $proxyDirectives }}
      {{ if $proxyImport }}import {{ $proxyImport }}{{ end }}
      {{ range $i, $container := $containers }}
      {{ range $j, $net := $container.Networks }}
      {{ $port := or (trim (index $container.Labels "virtual.port")) "80" }}
      to {{ $net.IP }}:{{ $port }}
      header_up Authorization {http.request.header.Authorization}
      header_up X-User-Sub {http.auth.claims.sub}
      header_up X-User-Email {http.auth.claims.email}
      header_up X-User-Roles {http.auth.claims.roles}
      header_up X-Real-IP {remote_host}
      header_up X-Tlen-IP {remote_host}
      header_up X-Forwarded-For {remote_host}
      {{ end }}
      {{ end }}
    }
  }
  {{ else if $basicauth }}
  # ===== BASIC AUTH BLOCK =====
  basicauth {{ $authPath }} {
      {{ $authUsername }} {{ $authPassword }}
  }

  reverse_proxy {{ $proxyMatcher }} {
    lb_policy {{ $proxyLBPolicy }}
    {{ $proxyDirectives }}
    {{ if $proxyImport }}import {{ $proxyImport }}{{ end }}
    {{ range $i, $container := $containers }}
    {{ range $j, $net := $container.Networks }}
    {{ $port := or (trim (index $container.Labels "virtual.port")) "80" }}
    to {{ $net.IP }}:{{ $port }}
    header_up X-Real-IP {remote_host}
    header_up X-Tlen-IP {remote_host}
    header_up X-Forwarded-For {remote_host}
    {{ end }}
    {{ end }}
  }
  {{ else }}
  # ===== NO AUTH MODE =====
  reverse_proxy {{ $proxyMatcher }} {
    lb_policy {{ $proxyLBPolicy }}
    {{ $proxyDirectives }}
    {{ if $proxyImport }}import {{ $proxyImport }}{{ end }}
    {{ range $i, $container := $containers }}
    {{ range $j, $net := $container.Networks }}
    {{ $port := or (trim (index $container.Labels "virtual.port")) "80" }}
    to {{ $net.IP }}:{{ $port }}
    header_up X-Real-IP {remote_host}
    header_up X-Tlen-IP {remote_host}
    header_up X-Forwarded-For {remote_host}
    {{ end }}
    {{ end }}
  }
  {{ end }}

  log {
    output stdout
  }
}
{{ end }}
{{ end }}

{{ end }}

:2015

metrics
