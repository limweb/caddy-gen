{
	# Global Options
	auto_https disable_redirects
	log {
		format json
		level ERROR
	}

	servers {
		trusted_proxies static 0.0.0.0/0
	}
}

{{ $hosts := groupByLabel $ "virtual.host" }}

{{ if not $hosts }}

127.0.0.1:2015 {
  log {
      output stdout
  }
}

{{ else }}

{{ range $h, $containers := $hosts }}
{{ $c := first $containers }}
{{ $allhosts := trim (index $c.Labels "virtual.host") }}
{{ range $t, $host := split $allhosts " " }}
{{ $tlsEmail := trim (index $c.Labels "virtual.tls-email") }}
{{ $tlsConfig := trim (index $c.Labels "virtual.tls") }}
{{ $tlsEnv := or $tlsEmail $tlsConfig }}
{{ $tlsOff := eq $tlsEnv "" }}
{{ $tlsOn := ne $tlsEnv "" }}
{{ $alias := trim (index $c.Labels "virtual.alias") }}
{{ $aliasPresent := ne $alias "" }}
{{ $authUsername := trim (index $c.Labels "virtual.auth.username") }}
{{ $authPassword := trim (index $c.Labels "virtual.auth.password") }}
{{ $authPath := trim (index $c.Labels "virtual.auth.path") }}
{{ $basicauth := and (ne $authUsername "") (ne $authPassword "") }}
{{ $hostDirectives := trim (index $c.Labels "virtual.host.directives") }}
{{ $hostImport := trim (index $c.Labels "virtual.host.import") }}
{{ $proxyMatcher := trim (index $c.Labels "virtual.proxy.matcher") }}
{{ $proxyDirectives := trim (index $c.Labels "virtual.proxy.directives") }}
{{ $proxyLBPolicy := or (trim (index $c.Labels "virtual.proxy.lb_policy")) "round_robin" }}
{{ $proxyImport := trim (index $c.Labels "virtual.proxy.import") }}

# JWT Configuration from virtual labels
{{ $jwtIssuer := trim (index $c.Labels "virtual.jwt.issuer") }}
{{ $jwtAudience := trim (index $c.Labels "virtual.jwt.audience") }}
{{ $jwtJwks := trim (index $c.Labels "virtual.jwt.jwks_uri") }}
{{ $jwtRole := trim (index $c.Labels "virtual.jwt.require_role") }}
{{ $jwtEnabled := and (ne $jwtIssuer "") (ne $jwtJwks "") }}

# JWT Configuration from auth labels (simplified)
{{ $authValidateJwt := trim (index $c.Labels "auth.validatejwt") }}
{{ $authServer := trim (index $c.Labels "auth.server") }}
{{ $authRealm := trim (index $c.Labels "auth.realm") }}
{{ $authRoles := trim (index $c.Labels "auth.roles") }}
{{ $authClientid := trim (index $c.Labels "auth.clientid") }}

# Map auth.* to virtual.jwt.* if auth labels are present
{{ if and (eq $jwtIssuer "") (ne $authServer "") }}
{{ $jwtIssuer = print "https://" $authServer }}
{{ end }}
{{ if and (eq $jwtAudience "") (ne $authRealm "") }}
{{ $jwtAudience = $authRealm }}
{{ end }}
{{ if and (eq $jwtJwks "") (ne $authServer "") }}
{{ $jwtJwks = print "https://" $authServer "/.well-known/jwks.json" }}
{{ end }}
{{ if and (eq $jwtRole "") (ne $authRoles "") }}
{{ $jwtRole = $authRoles }}
{{ end }}

# Enable JWT if auth.validatejwt=true and we have auth.server
{{ if and (eq $jwtEnabled false) (eq $authValidateJwt "true") (ne $authServer "") }}
{{ $jwtEnabled = true }}
{{ end }}

# Rate Limit Configuration
{{ $rateLimitZone := trim (index $c.Labels "virtual.ratelimit.zone") }}
{{ $rateLimitKey := or (trim (index $c.Labels "virtual.ratelimit.key")) "{http.request.remote_ip}" }}
{{ $rateLimitEvents := or (trim (index $c.Labels "virtual.ratelimit.events")) "100" }}
{{ $rateLimitWindow := or (trim (index $c.Labels "virtual.ratelimit.window")) "1m" }}
{{ $rateLimitEnabled := ne $rateLimitZone "" }}
# Debug Mode - ตั้งค่า log level สำหรับ debugging
{{ $debugMode := trim (index $c.Labels "virtual.debug") }}
{{ $isDebug := eq $debugMode "true" }}
{{ if $isDebug }}{{ $logLevel = "DEBUG" }}{{ end }}
{{ $logLevel := trim (index $c.Labels "virtual.log.level") }}
{{ $logLevelSet := ne $logLevel "" }}
{{ if not $logLevelSet }}{{ $logLevel = "ERROR" }}{{ end }}

{{ if $aliasPresent  }}
{{ if $tlsOff }}http://{{ end }}{{ $alias }} {
  redir {{ if $tlsOff }}http://{{ else }}https://{{ end }}{{ $host }}
}
{{ end }}

{{ if $tlsOff }}http://{{ end }}{{ $host }} {
  {{ if $tlsOn }}tls {{ $tlsEnv }}{{ end }}

  # ===== CONFIGURATION =====
  # Host: {{ $host }}
  {{ if $tlsOn }}# TLS Mode: {{ $tlsEnv }}{{ end }}
  {{ if $jwtEnabled }}# JWT: Enabled ({{ $jwtIssuer }}){{ end }}
  {{ if $rateLimitEnabled }}# Rate Limit: {{ $rateLimitZone }} ({{ $rateLimitEvents }}/{{ $rateLimitWindow }}){{ end }}
  {{ if $jwtRole }}# Required Roles: {{ $jwtRole }}{{ end }}
  {{ if $isDebug }}# DEBUG MODE: Enabled{{ end }}

  encode zstd gzip
  
  {{ if $tlsOn }}
  # โหมด HTTPS → ลบ fingerprint + ใส่ HSTS
  header {
    -Server
    -X-Powered-By
    -Link
    Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    X-XSS-Protection "1; mode=block"
    X-Content-Type-Options "nosniff"
    X-Frame-Options "SAMEORIGIN"
    Referrer-Policy "same-origin"
    Permissions-Policy "geolocation=()"
  }
  {{ else }}
  # โหมด HTTP ธรรมดา → ลบ fingerprint อย่างเดียว
  header {
    -Server
    -X-Powered-By
    -Link
    X-XSS-Protection "1; mode=block"
    X-Content-Type-Options "nosniff"
    X-Frame-Options "SAMEORIGIN"
    Referrer-Policy "same-origin"
    Permissions-Policy "geolocation=()"
  }
  {{ end }}

  {{ $hostDirectives }}
  {{ if $hostImport }}import {{ $hostImport }}{{ end }}

  # ===== HEALTH CHECK FOR LOAD BALANCER =====
  handle /health {
    respond "OK" 200
  }

  # ===== BLOCK SENSITIVE FILES =====
  @blocked {
    path *.md *.mdown .htaccess .git .gitignore .env /.git*  /.git/* /configs/* /vendor/* /config/* /cronjob/*
  }
  respond @blocked 403

  {{ if $jwtEnabled }}
  # ===== JWT AUTH BLOCK =====
  route {
    jwt {
      primary yes
      trusted_tokens {
        static_secret {
          token_name access_token
        }
      }

      issuers {
        oidc {
          issuer {{ $jwtIssuer }}
          metadata_url {{ $jwtIssuer }}/.well-known/openid-configuration
          audience {{ $jwtAudience }}
        }
      }

      validate {
        exp
        nbf
        iat
      }
    }

    # ===== ROLE CHECK =====
    {{ if $jwtRole }}
    {{ $roles := split $jwtRole "," }}
    {{ if ne $authClientid "" }}
    # Keycloak: resource_access.{client_id}.roles
    {{ range $i, $role := $roles }}
    {{ if eq $i 0 }}@forbidden not (claim resource_access.{{ $authClientid }}.roles contains {{ trim $role }}){{ else }} and not (claim resource_access.{{ $authClientid }}.roles contains {{ trim $role }}){{ end }}
    {{ end }}
    {{ else }}
    # Keycloak: realm_access.roles
    {{ range $i, $role := $roles }}
    {{ if eq $i 0 }}@forbidden not (claim realm_access.roles contains {{ trim $role }}){{ else }} and not (claim realm_access.roles contains {{ trim $role }}){{ end }}
    {{ end }}
    {{ end }}
    respond @forbidden 403
    {{ end }}

    # ===== RATE LIMIT =====
    {{ if $rateLimitEnabled }}
    rate_limit {
      zone {{ $rateLimitZone }} {
        key {{ $rateLimitKey }}
        events {{ $rateLimitEvents }}
        window {{ $rateLimitWindow }}
      }
    }
    {{ end }}

    # ===== FORWARD CLAIMS + REVERSE PROXY =====
    reverse_proxy {{ $proxyMatcher }} {
      lb_policy {{ $proxyLBPolicy }}
      {{ $proxyDirectives }}
      {{ if $proxyImport }}import {{ $proxyImport }}{{ end }}
      {{ range $i, $container := $containers }}
      {{ range $j, $net := $container.Networks }}
      {{ $port := or (trim (index $container.Labels "virtual.port")) "80" }}
      to {{ $net.IP }}:{{ $port }}
      header_up Host {{ $host }}
      header_up Authorization {http.request.header.Authorization}
      header_up X-User-Sub {http.auth.claims.sub}
      header_up X-User-Email {http.auth.claims.email}
      header_up X-User-Roles {http.auth.claims.roles}
      header_up X-Real-IP {remote_host}
      header_up X-Tlen-IP {remote_host}
      {{ end }}
      {{ end }}
    }
  }
  {{ else if $basicauth }}
  # ===== BASIC AUTH BLOCK =====
  basicauth {{ $authPath }} {
      {{ $authUsername }} {{ $authPassword }}
  }

  # ===== RATE LIMIT =====
  {{ if $rateLimitEnabled }}
  rate_limit {
    zone {{ $rateLimitZone }} {
      key {{ $rateLimitKey }}
      events {{ $rateLimitEvents }}
      window {{ $rateLimitWindow }}
    }
  }
  {{ end }}

  reverse_proxy {{ $proxyMatcher }} {
    lb_policy {{ $proxyLBPolicy }}
    {{ $proxyDirectives }}
    {{ if $proxyImport }}import {{ $proxyImport }}{{ end }}
    {{ range $i, $container := $containers }}
    {{ range $j, $net := $container.Networks }}
    {{ $port := or (trim (index $container.Labels "virtual.port")) "80" }}
    to {{ $net.IP }}:{{ $port }}
    header_up X-Real-IP {remote_host}
    header_up X-Tlen-IP {remote_host}
    {{ end }}
    {{ end }}
  }
  {{ else }}
  # ===== NO AUTH MODE =====
  # ===== RATE LIMIT =====
  {{ if $rateLimitEnabled }}
  rate_limit {
    zone {{ $rateLimitZone }} {
      key {{ $rateLimitKey }}
      events {{ $rateLimitEvents }}
      window {{ $rateLimitWindow }}
    }
  }
  {{ end }}

  reverse_proxy {{ $proxyMatcher }} {
    lb_policy {{ $proxyLBPolicy }}
    {{ $proxyDirectives }}
    {{ if $proxyImport }}import {{ $proxyImport }}{{ end }}
    {{ range $i, $container := $containers }}
    {{ range $j, $net := $container.Networks }}
    {{ $port := or (trim (index $container.Labels "virtual.port")) "80" }}
    to {{ $net.IP }}:{{ $port }}
    header_up X-Real-IP {remote_host}
    header_up X-Tlen-IP {remote_host}
    {{ end }}
    {{ end }}
  }
  {{ end }}

  log {
    output stdout
    level {{ $logLevel }}
  }
}
{{ end }}
{{ end }}

{{ end }}

:2015

metrics
